# STT Gateway Microservice (NestJS + Fastify)

–í—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏ –∞—É–¥–∏–æ –ø–æ URL –Ω–∞ –±–∞–∑–µ NestJS + Fastify. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ AssemblyAI. –ë–µ–∑ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, Swagger, GraphQL –∏ rate limiting.

## –ß—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ

- üè• –ü—Ä–æ—Å—Ç–æ–π health-check —ç–Ω–¥–ø–æ–∏–Ω—Ç `/{API_BASE_PATH}/{API_VERSION}/health`
- üìä –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Pino (JSON –≤ prod)
- üõ°Ô∏è –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –æ—à–∏–±–æ–∫
- ‚ö° Fastify
- üß™ –ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ Jest-—Ç–µ—Å—Ç—ã (unit –∏ e2e)
- üê≥ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Ä–∞–±–æ—Ç–µ –≤ Docker
- üéôÔ∏è STT —ç–Ω–¥–ø–æ–∏–Ω—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ AssemblyAI

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:

- Node.js 22+
- pnpm 10+

```bash
# 1) –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
pnpm install

# 2) –û–∫—Ä—É–∂–µ–Ω–∏–µ (prod)
cp env.production.example .env.production

# 3) –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ (prod)
pnpm build
pnpm start:prod
```

URL –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (prod): `http://localhost:80/api/v1`
–î–ª—è Docker Compose: `http://localhost:8080/api/v1`

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–§–∞–π–ª—ã –æ–∫—Ä—É–∂–µ–Ω–∏—è:

- `.env.production`
- `.env` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö: `.env.production.example`.

–ö–ª—é—á–µ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

- `NODE_ENV` ‚Äî `production|development|test`
- `LISTEN_HOST` ‚Äî –Ω–∞–ø—Ä–∏–º–µ—Ä, `0.0.0.0` –∏–ª–∏ `localhost`
- `LISTEN_PORT` ‚Äî –Ω–∞–ø—Ä–∏–º–µ—Ä, `80` –∏–ª–∏ `3000`
- `API_BASE_PATH` ‚Äî –ø—Ä–µ—Ñ–∏–∫—Å API (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `api`)
- `API_VERSION` ‚Äî –≤–µ—Ä—Å–∏—è API (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `v1`)
- `LOG_LEVEL` ‚Äî `trace|debug|info|warn|error|fatal|silent`
- `TZ` ‚Äî —Ç–∞–π–º–∑–æ–Ω–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `UTC`)

## –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã

- `GET /{API_BASE_PATH}/{API_VERSION}` ‚Äî –∏–Ω–¥–µ–∫—Å API, —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã
- `GET /{API_BASE_PATH}/{API_VERSION}/health` ‚Äî –±–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è
- `POST /{API_BASE_PATH}/{API_VERSION}/transcriptions/file` ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è –∞—É–¥–∏–æ –ø–æ URL

–ü—Ä–∏–º–µ—Ä—ã:

–ò–Ω–¥–µ–∫—Å API

```bash
curl http://localhost:80/api/v1
```

–¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è —Ñ–∞–π–ª–∞ –ø–æ URL

```bash
curl -X POST \
  http://localhost:80/api/v1/transcriptions/file \
  -H 'Content-Type: application/json' \
  -d '{
    "audioUrl": "https://example.com/audio.mp3",
    "provider": "assemblyai",
    "timestamps": false
  }'
```

–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:

```json
{
  "audioUrl": "https://example.com/audio.mp3", // –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π URL (http/https), –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ/loopback —Ö–æ—Å—Ç—ã –∑–∞–ø—Ä–µ—â–µ–Ω—ã
  "provider": "assemblyai",                     // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ; –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é assemblyai
  "timestamps": false,                           // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ; –≤–∫–ª—é—á–∞–µ—Ç –æ—Ç–º–µ—Ç–∫–∏ —Å–ª–æ–≤
  "apiKey": "YOUR_ASSEMBLYAI_KEY"              // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ; –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –µ—Å–ª–∏ ALLOW_CUSTOM_API_KEY=true
}
```

–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ (200 OK):

```json
{
  "text": "Transcribed text...",
  "provider": "assemblyai",
  "requestId": "abc123",
  "durationSec": 123.45,
  "language": "en",
  "confidenceAvg": 0.92,
  "wordsCount": 204,
  "processingMs": 8421,
  "timestampsEnabled": false
}
```

–ö–æ–¥—ã –æ—Ç–≤–µ—Ç–æ–≤:

- `200 OK` ‚Äî —É—Å–ø–µ—à–Ω–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è
- `400 Bad Request` ‚Äî –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã/URL, –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ —Ö–æ—Å—Ç—ã, –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞, –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä
- `401 Unauthorized` ‚Äî –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç API –∫–ª—é—á –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (–∫–æ–≥–¥–∞ `ALLOW_CUSTOM_API_KEY=false` –∏ –Ω–µ –∑–∞–¥–∞–Ω `ASSEMBLYAI_API_KEY`)
- `503 Service Unavailable` ‚Äî –æ—à–∏–±–∫–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
- `504 Gateway Timeout` ‚Äî –ø—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏

## –¢–µ—Å—Ç—ã
–°–º. –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ `docs/dev.md`.

## Docker

- Dockerfile –æ–∂–∏–¥–∞–µ—Ç —É–∂–µ —Å–æ–±—Ä–∞–Ω–Ω—ã–π `dist/`
- –ü—Ä–∏–º–µ—Ä –∑–∞–ø—É—Å–∫–∞ ‚Äî `docker/docker-compose.yml`
- –î–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ —É–∫–∞–∂–∏—Ç–µ `ASSEMBLYAI_API_KEY` —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `ALLOW_CUSTOM_API_KEY=true` –∏ –ø–µ—Ä–µ–¥–∞–≤–∞–π—Ç–µ `apiKey` –≤ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–∞.

```bash
# –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
pnpm build

# –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ compose (–±–µ–∑ cd)
docker compose -f docker/docker-compose.yml up -d --build
```

–ü–æ–¥—Ä–æ–±–Ω–µ–µ —Å–º. `docs/DOCKER.md`.

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–µ—Ä–≤–∏—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `nestjs-pino`:

- –í dev ‚Äî —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç (`pino-pretty`).
- –í prod ‚Äî JSON-–ª–æ–≥–∏ —Å –ø–æ–ª–µ–º `@timestamp` –∏ –±–∞–∑–æ–≤—ã–º–∏ –ø–æ–ª—è–º–∏ `service`, `environment`.
- –†–µ–¥–∞–∫—Ç–∏—Ä—É—é—Ç—Å—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏: `authorization`, `x-api-key`.
- –í prod –Ω–µ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ `/health`.

–ü–æ–¥—Ä–æ–±–Ω–µ–µ —Å–º. `docs/LOGGING.md`.

## –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –í –ø—Ä–æ–µ–∫—Ç–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç Swagger –∏ GraphQL.
- –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞.

## –õ–∏—Ü–µ–Ω–∑–∏—è

MIT
