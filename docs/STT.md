# Поведение транскрибации и обработка URL

## Поток запроса

- POST /{API_BASE_PATH}/{API_VERSION}/transcriptions/file
- Проверка входных данных
  - URL должен быть http(s).
  - Запрещены приватные и loopback-хосты (например, 127.0.0.1, localhost, 10.0.0.0/8 и т.д.).
- Проверка размера (без скачивания файла)
  - Выполняется HEAD к `audioUrl`.
  - Если источник возвращает заголовок `Content-Length`, размер сравнивается с `STT_MAX_FILE_SIZE_MB`.
  - Если размер превышает лимит — ответ `400 File too large`.
  - Если `Content-Length` отсутствует или HEAD недоступен — проверка пропускается.
- Передача провайдеру
  - Сервис НЕ скачивает аудио.
  - Провайдеру передаётся исходная ссылка (например, для AssemblyAI поле `audio_url`).
- Ожидание результата
  - Таймаут единичных HTTP-запросов: `STT_REQUEST_TIMEOUT_SEC`.
  - Интервал опроса статуса: `STT_POLL_INTERVAL_MS`.
  - Максимальное время синхронного ожидания: `STT_MAX_SYNC_WAIT_MIN` (после чего `504 Gateway Timeout`).

## Переменные окружения (STT)

- `STT_DEFAULT_PROVIDER` — провайдер по умолчанию (например, `assemblyai`).
- `STT_ALLOWED_PROVIDERS` — список разрешённых провайдеров.
- `STT_MAX_FILE_SIZE_MB` — лимит размера файла в мегабайтах. Применяется только если источник возвращает `Content-Length` на HEAD; тело не скачивается.
- `STT_REQUEST_TIMEOUT_SEC` — таймаут HTTP-запросов к провайдеру.
- `STT_POLL_INTERVAL_MS` — интервал опроса статуса транскрипции.
- `STT_MAX_SYNC_WAIT_MIN` — максимальное ожидание синхронной транскрипции.
- `ASSEMBLYAI_API_KEY` — опциональный ключ провайдера; используется как fallback, если в запросе не передан `apiKey`.

## Коды ответов (основные)

- `200 OK` — транскрипция завершена.
- `400 Bad Request` — невалидный URL, приватный хост, неподдерживаемый провайдер, превышен лимит размера (если известен `Content-Length`).
- `401 Unauthorized` — отсутствует API-ключ провайдера.
- `503 Service Unavailable` — ошибка провайдера.
- `504 Gateway Timeout` — истекло максимальное время ожидания синхронной транскрипции.
